# Hard Disks and Their Management
## Hard Disk Drive
- Hard disk drive has been **the main form of persistent data storage** in computer systems for decades
    - The drive consists of a large number of **sectors** (512-byte blocks)
    - sectors size is a de-facto-standard
        - not exactly standard, but made standard by society
    - **Address Space**:
        - We can view the disk with n sectors as <u>an array of</u> sectors; 0 to n-1

## Interface
> Important for Finals
- The only guarantee is that a single 512-byte write is **atomic**
    - All or nothing
- Multi-sector operations are possible
    - Many file systems will read or write 4KB at a time
    - **Torn write**:
        - If an untimely power loss occurs, only a portion of a larger write may complete
- Accessing blocks in **a contiguous chunk** is the fastest access mode
    - A sequential read or write
    - Much faster than any more random access pattern

## Basic Geometry
- **Platter** (Aluminum coated with a thin magnetic layer)
    - A circular hard surface
    - Data is stored persistently by inducing magnetic changes to it
    - Each platter has 2 sides, each of which is called a **surface**
- **Spindle**
    - Spindle is connected to a motor that spins the platter around
    - The rate of rotations is measured in **RPM** (Rotations Per Minute)
        - Typical modern values: 7,200 RPM to 15,000 RPM
        - E.g., 10000 RPM: A single rotation takes around about 6 ms
- **Track**
    - Concentric circles of sectors
    - Data is encoded on each surface in a track
    - A single surface contains many thousands and thousands of tracks

## A Simple Disk Drive
- **Disk head** (One head per surface of the drive)
    - The process of *reading* and *writing* is accomplished by the **disk head**
    - Attached to a single disk arm, which moves across the surface

## Single-track Latency: The Rotational Delay
- **Rotational delay**: Time for the desired sector to rotate
    - Ex) Full rotational delay is R and we start at sector 6
        - Read sector 0: Rotational delay = $\frac{R}{2}$
        - Read sector 5: Rotational delay = R - 1 (worst case)

## Multiple Tracks: Seek Time
- **Seek** Move the disk arm to the correct track
    - **Seek time**: Time to move head to the track contain the desired sector
    - One of the most costly disk operations

## Phases of Seek
- Acceleration -> Coasting -> Deceleration -> Settling
    - **Acceleration**: The disk arm gets moving
    - **Coasting**: The arm is moving at full speed
    - **Deceleration**: The arm slows down
    - **Settling**: The head is *carefully positioned* over the correct track
        - The settling time is often quite significant, e.g., 0.5 to 2ms

## Transfer
- The final phase of I/O
    - Data is either *read from* or *written* to the surface
> IMPORTANT
- Complete I/O time:
    - **Seek**
    - Waiting for the **rotational delay**
    - **Transfer**

## Track Skew
- Make sure that sequential reads can be properly serviced **even when crossing track boundaries**
    - *Without track skew*, the head would be moved to the next track but the desired next block would have already rotated under the head

## Cache (Track Buffer)
- **Hold data** read from or written to the disk
    - Allow the drive to <u>quickly respond</u> to requests
    - Small amount of memory (usually around 8 or 16 MB)

## Write on Cache
- **Writeback** (Immediate reporting)
    - Acknowledge a write has completed when it has **put the data in its memoy**
    - faster but dangerous
- **Write through**
    - Acknowledge a write has completed after the write has **actually been written to disk**

## I/O Time: Doing The Math
- I/O time ($T_{I/O}$):
$$T_{I/O} = T_{\text{seek}} + T_{\text{rotation}} + T_{\text{transfer}}$$
- The rate of I/O
$$R_{I/O} = \frac{\text{Size}_{\text{transfer0}}}{T_{I/O}}$$

- Disk Drive Specs: SCSI Versus SATA

| | **Cheetah 15K.5** | **Barracuda** |
| -- | -- | -- |
| Capacity | 300 GB | 1 TB |
| RPM | 15,000 | 7,200 |
| Average Seek | 4ms | 9ms |
| Max Transfer | 125 MB/s | 105 MB/s |
| Platters | 4 | 4 |
| Cache | 16 MB | 16/32 MB |
| Connects Via | SCSI | SATA |

### Example
- **Random workload**: Issue 4KB read to random locations on the disk
- **Sequential workload**: Read 100MB consecutively from the disk

> There is a huge gap in drive performance between **random** and **sequential** workloads

| | **Cheetah 15K.5** | **Barracuda** |
| -- | -- | -- |
| $T_{\text{seek}}$ | 4ms | 9ms |
| $T_{\text{rotation}}$ | 2ms | 4.2ms |
| $T_{\text{transfer random}}$ | 30 micro sec | 38 micro sec |
| $T_{\text{I/O random}}$ | 6ms | 13.2ms |
| $R_{\text{I/O random}}$ | 0.66 MB/s | 0.31 MB/s |
| $T_{\text{transfer sequential}}$ | 800ms | 950msc |
| $T_{\text{I/O sequential}}$ | 806ms | 963.2ms |
| $R_{\text{I/O sequential}}$ | 125 MB/s | 105 MB/s |

## Disk Scheduling
- **Disk Scheduler** decides <u>which I/O request</u> to schedule next
- **SSTF** (Shortest Seek Time First)
    - Order the queue of I/O request by track
    - Pick requests on the nearest track to complete first

### SSTF is not a Panacea
- **Problem 1**: The drive geometry is not available to the host OS
    - Solution: OS can simply implement <u>Nearest-block-first</u> (NBF)
- **Problem 2**: Starvation
    - If there were a steady stream of request to the inner track, request to other tracks would then be ignored completely

### Elevator (a.k.a. SCAN or C-SCAN)
- Move across the disk servicing requests in order across the tracks
    - **Sweep (Elevator)**
        - A single pass across the disk
        - If a request comes for a block on a track that has already been serviced during this sweep of the disk, it is queued until the next sweep
    - **F-SCAN**
        - Freezes the queue to be serviced when it starts a sweep
        - This helps avoid starvation of far-away requests by ensuring that all requests in the current queue are processed before any new requests are added to the queue
    - **C-SCAN (Circular SCAN)**
        - Sweeps from the outermost track to the innermost track, and then immediately returns to the outermost track without servicing any requests on the return trip, before starting the next sweep from outer to inner again
        - This ensures uniform wait times and prevents starvation of requests

### How to Account for Disk Rotation Costs?
- If rotation is faster than seek: request 16 -> request 8
- If seek is faster than rotation: request 8 -> request 16
> On modern drives, both seek and rotation are roughly equivalent: **THUS, SPTF (Shortest Positioning Time First) is useful**

## I/O Merging
- **Reduce the number of request** sent to the disk and lowers overhead
    - E.g., read blocks 33, then 8, then 34:
        - The scheduler merge the request for blocks 33 and 34 into a *single two-block request*